<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeLungs - Lung Health Assessment</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #2c5f6f 0%, #4a8a9e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            text-align: center;
            padding: 40px 20px;
            max-width: 800px;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 300;
            margin-bottom: 30px;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.8rem;
            font-weight: 400;
            margin-bottom: 25px;
            opacity: 0.95;
        }

        .description {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 50px;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-button {
            background-color: #1a9b8e;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .cta-button:hover {
            background-color: #168a7e;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .cta-button:active {
            transform: translateY(0);
        }

        /* Popup Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            height: 700px;
            max-height: 90vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #2c5f6f 0%, #4a8a9e 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            font-weight: 500;
        }

        .close-button {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
        }

        #customChat {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .question-container {
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .question-text {
            font-size: 24px;
            color: #1e3a5f;
            margin-bottom: 40px;
            line-height: 1.4;
            font-weight: 400;
        }

        .answer-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .answer-btn {
            background: #00a896;
            color: white;
            border: none;
            padding: 18px 60px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 200px;
        }

        .answer-btn:hover {
            background: #008c7a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,168,150,0.3);
        }

        .answer-btn:active {
            transform: translateY(0);
        }

        .text-input-container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
        }

        .text-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #00a896;
            border-radius: 25px;
            outline: none;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            border-color: #008c7a;
            box-shadow: 0 0 0 3px rgba(0,168,150,0.1);
        }

        .submit-btn {
            margin-top: 15px;
            background: #00a896;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #008c7a;
        }

        #webchat {
            width: 100%;
            height: 100%;
            display: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #2c5f6f;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2c5f6f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .progress-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #666;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            .subtitle {
                font-size: 1.4rem;
            }

            .description {
                font-size: 1rem;
            }

            .modal-content {
                width: 95%;
                height: 90vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Are Your Lungs Safe?</h1>
        <p class="subtitle">Let SafeLungs Help You Find Out</p>
        <p class="description">
            Take SafeLungs Assessment to understand your lung health better and get personalized recommendations.
        </p>
        <button class="cta-button" onclick="openHealthBot()">Start SafeLungs Assessment</button>
    </div>

    <!-- Welcome Screen 1 -->
    <div id="welcomeModal1" class="modal">
        <div class="modal-content" style="height: auto; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 40px; position: relative;">
                <button class="close-button" onclick="closeAllModals()" style="position: absolute; top: 20px; right: 20px; color: #666;">&times;</button>

                <h2 style="color: #1e3a5f; font-size: 32px; margin-bottom: 25px;">Welcome to SafeLungs</h2>

                <p style="color: #333; font-size: 16px; line-height: 1.8; margin-bottom: 25px;">
                    You are about to take your first important step in understanding your lung health. After answering my questions, you can save and print out your answers summary and bring it with you to your doctor's visit. This assessment can be completed for yourself or on behalf of someone you care about. We will begin the test when you are ready.
                </p>

                <button class="cta-button" onclick="showWelcomeScreen2()" style="margin-top: 20px;">Next</button>

                <p style="color: #999; font-size: 13px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    AE-NON-00659. Expiry Date: 8.10.2027
                </p>
            </div>
        </div>
    </div>

    <!-- Welcome Screen 2 -->
    <div id="welcomeModal2" class="modal">
        <div class="modal-content" style="height: auto; max-height: 85vh; overflow-y: auto;">
            <div style="padding: 40px; position: relative;">
                <button class="close-button" onclick="closeAllModals()" style="position: absolute; top: 20px; right: 20px; color: #666;">&times;</button>

                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px;">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C10.9 2 10 2.9 10 4C10 4.7 10.4 5.4 11 5.7V7C8.2 7.4 6 9.7 6 12.5V17L4 19V20H20V19L18 17V12.5C18 9.7 15.8 7.4 13 7V5.7C13.6 5.4 14 4.7 14 4C14 2.9 13.1 2 12 2ZM12 9C14.2 9 16 10.8 16 13V18H8V13C8 10.8 9.8 9 12 9Z" fill="#0066cc"/>
                    </svg>
                    <h2 style="color: #0066cc; font-size: 28px; margin: 0;">SafeLungs</h2>
                </div>

                <p style="color: #333; font-size: 16px; line-height: 1.8; margin-bottom: 20px;">
                    Before we begin, I want to make it clear that I am not a diagnostic tool or provide any form of healthcare advice, and therefore do not replace contact with healthcare professionals or a physician's assessment. My aim is to increase awareness among adults about lung diseases, including lung cancer, and to help those who have completed the questionnaire to understand, on a general basis, the possible next steps that are available. Please note that if you are acutely ill, you should contact healthcare services, for advice.
                </p>

                <p style="color: #333; font-size: 16px; font-weight: 600; margin-bottom: 25px;">
                    I am developed by MSD.
                </p>

                <button class="cta-button" onclick="showChatModal()" style="margin-top: 20px;">Move On</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>SafeLungs Health Assessment</h2>
                <button class="close-button" onclick="closeHealthBot()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Connecting to SafeLungs...</p>
                </div>
                <!-- Direct Line Web Chat -->
                <div id="webchat" style="height: 600px; width: 100%; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Bot Framework Web Chat -->
    <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>

    <script>
        // Use relative URL when on same server, or full URL for external hosting
        const API_BASE_URL = window.location.origin;

        // Show first welcome screen
        function openHealthBot() {
            const modal = document.getElementById('welcomeModal1');
            modal.classList.add('active');
        }

        // Show second welcome screen
        function showWelcomeScreen2() {
            document.getElementById('welcomeModal1').classList.remove('active');
            document.getElementById('welcomeModal2').classList.add('active');
        }

        // Show chat modal and initialize bot
        async function showChatModal() {
            // Hide welcome screen
            document.getElementById('welcomeModal2').classList.remove('active');

            // Show chat modal
            const modal = document.getElementById('chatModal');
            const loading = document.getElementById('loading');
            const webchatDiv = document.getElementById('webchat');

            modal.classList.add('active');
            loading.style.display = 'block';
            webchatDiv.innerHTML = '';

            try {
                // Get Direct Line token from your API
                console.log('Fetching Direct Line token...');
                const response = await fetch(`${API_BASE_URL}/api/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Token API error:', response.status, errorText);
                    throw new Error(`Failed to get token: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Token received successfully:', data);

                // Create Direct Line connection
                const directLine = window.WebChat.createDirectLine({
                    token: data.token
                });

                // Track last message to prevent consecutive duplicates
                let lastMessageText = null;

                // Create store with middleware to invoke scenario and filter duplicates
                const store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
                    if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
                        console.log('‚úì Direct Line connection established');
                        // Dispatch InitConversation to trigger the scenario
                        dispatch({
                            type: 'DIRECT_LINE/POST_ACTIVITY',
                            meta: { method: 'keyboard' },
                            payload: {
                                activity: {
                                    type: 'invoke',
                                    name: 'InitConversation',
                                    locale: 'en-US',
                                    value: {
                                        triggeredScenario: {
                                            trigger: 'questionnaireflow001',
                                            args: {}
                                        }
                                    }
                                }
                            }
                        });
                        console.log('‚úì InitConversation sent to bot');
                    }

                    // Log outgoing messages (user answers)
                    if (action.type === 'DIRECT_LINE/POST_ACTIVITY') {
                        const activity = action.payload.activity;
                        if (activity.type === 'message' && activity.text) {
                            console.log('üì§ User sent answer:', activity.text);
                        }
                    }

                    // Filter consecutive duplicate messages from bot
                    if (action.type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
                        const activity = action.payload.activity;

                        // Log incoming bot messages
                        if (activity.type === 'message' && activity.text) {
                            console.log('üì• Bot received message:', activity.text.substring(0, 100));
                        }

                        if (activity.type === 'message' && activity.text && activity.from && activity.from.id === 'lungbot-vxavep9') {
                            // If this is the same text as the last message, skip it
                            if (activity.text === lastMessageText) {
                                console.log('‚ö†Ô∏è Skipping duplicate consecutive message');
                                return; // Don't pass this action through
                            }
                            lastMessageText = activity.text;
                        }
                    }

                    return next(action);
                });

                // Render Web Chat
                window.WebChat.renderWebChat(
                    {
                        directLine: directLine,
                        store: store,
                        locale: 'en-US',
                        styleOptions: {
                            botAvatarInitials: 'SL',
                            userAvatarInitials: 'You',
                            hideUploadButton: true,

                            // Style suggested action buttons
                            suggestedActionBackgroundColor: '#5ec5b6',
                            suggestedActionBackgroundColorOnHover: '#4db3a4',
                            suggestedActionBackgroundColorOnActive: '#3da393',
                            suggestedActionTextColor: 'white',
                            suggestedActionBorderRadius: 25,
                            suggestedActionHeight: 40
                        }
                    },
                    webchatDiv
                );

                // Hide loading and show webchat
                loading.style.display = 'none';
                webchatDiv.style.display = 'block';

                console.log('‚úì Web Chat initialized successfully');

            } catch (error) {
                console.error('Error initializing health bot:', error);
                const errorMessage = error.message || 'Unknown error';
                loading.innerHTML = `
                    <div style="color: #d32f2f; padding: 20px;">
                        <p style="font-weight: bold; margin-bottom: 10px; font-size: 1.1rem;">Connection Failed</p>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">Unable to connect to SafeLungs.</p>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">Error: ${errorMessage}</p>
                        <button onclick="closeHealthBot()" style="margin-top: 10px; padding: 10px 20px; background: #2c5f6f; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
                        <button onclick="closeHealthBot(); setTimeout(openHealthBot, 500);" style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background: #1a9b8e; color: white; border: none; border-radius: 5px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        function closeHealthBot() {
            const modal = document.getElementById('chatModal');
            modal.classList.remove('active');

            // Reset modal content
            setTimeout(() => {
                const webchatDiv = document.getElementById('webchat');
                const loading = document.getElementById('loading');

                // Clear webchat
                webchatDiv.innerHTML = '';
                webchatDiv.style.display = 'none';

                // Show loading again
                loading.style.display = 'block';
                loading.innerHTML = `
                    <div class="spinner"></div>
                    <p>Connecting to SafeLungs...</p>
                `;
            }, 300);
        }

        function closeAllModals() {
            document.getElementById('welcomeModal1').classList.remove('active');
            document.getElementById('welcomeModal2').classList.remove('active');
            closeHealthBot();
        }

        // Note: With iframe approach, all bot interaction is handled by the embedded webchat
        // No need for custom message handling functions

        // Close modal when clicking outside
        document.getElementById('chatModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeHealthBot();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeHealthBot();
            }
        });
    </script>
</body>
</html>

